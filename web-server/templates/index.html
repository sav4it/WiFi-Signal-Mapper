<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wi-Fi Signal Mapper: {{ title }}</title>
    <!-- Connect Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .controls { margin-bottom: 20px; padding: 15px; background-color: #ecf0f1; border-radius: 8px; }
        label { margin-right: 10px; font-weight: 600; color: #34495e; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #bdc3c7; }
        #rssiChart { margin-top: 20px; border: 1px solid #ecf0f1; border-radius: 8px; padding: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Wi-Fi signal map (Linear measurement)</h1>
        <p>
            <strong>Status:</strong> The Flask server is running. The graph is updated every 5 seconds.
The X-axis is the measurement sequence number, the Y-axis is the signal strength (RSSI, in dBm).
        </p>

        <div class="controls">
            <label for="ssidFilter">Network filter (SSID):</label>
            <select id="ssidFilter" onchange="fetchDataAndDrawChart()">
                <option value="all">All networks</option>
            </select>
        </div>
        
        <!-- Container for Chart.js -->
        <div>
            <canvas id="rssiChart"></canvas>
        </div>

        <script>
            let rssiChart;
            
            // Generate distinct colors for the graph lines
            function getColors(num) {
                const colors = [
                    'rgba(52, 152, 219, 1)',  // Blue
                    'rgba(46, 204, 113, 1)',  // Green
                    'rgba(230, 126, 34, 1)',  // Orange
                    'rgba(155, 89, 182, 1)',  // Purple
                    'rgba(231, 76, 60, 1)'    // Red
                ];
                return colors[num % colors.length];
            }

            // Function to fetch data from Flask API and redraw the chart
            async function fetchDataAndDrawChart() {
                const selectedSsid = document.getElementById('ssidFilter').value;
                
                try {
                    // Fetch data, passing the selected SSID as a query parameter
                    const response = await fetch(`/api/chart_data?ssid=${selectedSsid}`);
                    const json = await response.json();

                    if (!json || !json.data) {
                        console.error("Invalid data structure from API.");
                        return;
                    }
                    
                    const chartData = json.data;
                    const ssids = json.ssids || [];
                    
                    // Update the SSID filter dropdown
                    const filter = document.getElementById('ssidFilter');
                    const currentSelected = filter.value;
                    filter.innerHTML = '<option value="all">All networks</option>';
                    ssids.forEach(ssid => {
                        const option = document.createElement('option');
                        option.value = ssid;
                        option.textContent = ssid;
                        if (ssid === currentSelected) {
                            option.selected = true;
                        }
                        filter.appendChild(option);
                    });


                    // Prepare datasets for Chart.js
                    const datasets = [];
                    let labels = [];

                    // If 'all' is selected, Chart.js needs a common set of labels (all IDs)
                    if (selectedSsid === 'all') {
                         Object.values(chartData).forEach(d => {
                             d.ids.forEach(id => {
                                 if (!labels.includes(id)) {
                                     labels.push(id);
                                 }
                             });
                         });
                         labels.sort((a, b) => a - b);
                    }


                    let colorIndex = 0;
                    for (const [ssid, data] of Object.entries(chartData)) {
                        const color = getColors(colorIndex++);
                        
                        // If 'all' is selected, use the combined list of IDs as labels
                        const currentLabels = (selectedSsid === 'all') ? labels : data.ids;

                        // Create data points, ensuring alignment with the common labels if necessary
                        const dataPoints = currentLabels.map(id => {
                            const index = data.ids.indexOf(id);
                            return index !== -1 ? data.rssi_values[index] : null;
                        });

                        datasets.push({
                            label: ssid,
                            data: dataPoints,
                            borderColor: color,
                            backgroundColor: color.replace('1)', '0.2)'), // lighter background for points
                            fill: false,
                            tension: 0.1,
                            spanGaps: true // Hide null points between scans
                        });
                    }
                    
                    if (datasets.length === 0) {
                         // Fallback for an empty dataset, use a simple label list
                         labels = [1, 2, 3, 4, 5]; 
                    }
                    
                    // Destroy the previous chart instance if it exists
                    if (rssiChart) {
                        rssiChart.destroy();
                    }

                    // Create the new chart
                    const ctx = document.getElementById('rssiChart').getContext('2d');
                    rssiChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels, // X-axis: Sequence ID
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Sequence Measurement ID (X)'
                                    },
                                    ticks: {
                                        callback: function(value, index, values) {
                                            // Show only integer IDs
                                            return Number.isInteger(labels[index]) ? labels[index] : '';
                                        }
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'RSSI Signal Strength (dBm)'
                                    },
                                    beginAtZero: false,
                                    suggestedMin: -100, // Good range for RSSI
                                    suggestedMax: -30,
                                    reverse: true // Stronger signal (less negative) is higher on the chart
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Wi-Fi Signal Change Across Measurement Points'
                                }
                            }
                        }
                    });

                } catch (error) {
                    console.error("Error fetching or drawing chart data:", error);
                    // Display an error message on the UI if needed
                }
            }

            // Initial chart draw and set up auto-refresh
            document.addEventListener('DOMContentLoaded', () => {
                fetchDataAndDrawChart();
                // Auto-refresh the chart every 5 seconds to show new data
                setInterval(fetchDataAndDrawChart, 5000); 
            });
        </script>
    </div>

</body>
</html>